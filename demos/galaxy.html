<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Density Waves</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; }
        canvas { display: block; }
        #ui {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            padding: 16px;
            border-radius: 8px;
            color: #fff;
            font: 13px system-ui, sans-serif;
            z-index: 10;
            min-width: 220px;
        }
        #ui h1 { font-size: 15px; margin-bottom: 12px; color: #ffd700; }
        .row { margin-bottom: 10px; }
        .row label { display: block; margin-bottom: 4px; color: #aaa; }
        .row input { width: 100%; }
        .row span { float: right; color: #ffd700; }
        #info {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            padding: 12px 16px;
            border-radius: 8px;
            color: #888;
            font: 12px system-ui, sans-serif;
            max-width: 320px;
            line-height: 1.5;
        }
        #info strong { color: #ffd700; }
        #viewToggle {
            margin-top: 12px;
            padding: 8px 12px;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        #viewToggle:hover { background: #333; }
    </style>
</head>
<body>
    <canvas id="c"></canvas>
    <div id="ui">
        <h1>Density Wave Controls</h1>
        <div class="row">
            <label>Stars <span id="vStars">8000</span></label>
            <input type="range" id="sStars" min="2000" max="20000" value="8000" step="500">
        </div>
        <div class="row">
            <label>Spiral Arms <span id="vArms">2</span></label>
            <input type="range" id="sArms" min="1" max="6" value="2" step="1">
        </div>
        <div class="row">
            <label>Arm Tightness <span id="vTight">0.4</span></label>
            <input type="range" id="sTight" min="0.1" max="1.0" value="0.4" step="0.05">
        </div>
        <div class="row">
            <label>Wave Strength <span id="vWave">0.5</span></label>
            <input type="range" id="sWave" min="0.1" max="1.0" value="0.5" step="0.05">
        </div>
        <div class="row">
            <label>Pattern Speed <span id="vPat">1.0</span></label>
            <input type="range" id="sPat" min="0.1" max="3.0" value="1.0" step="0.1">
        </div>
        <div class="row">
            <label>Rotation Speed <span id="vRot">1.0</span></label>
            <input type="range" id="sRot" min="0.0" max="2.0" value="1.0" step="0.1">
        </div>
        <button id="viewToggle">Toggle Velocity View</button>
    </div>
    <div id="info">
        <strong>Density Wave Theory:</strong> Stars orbit at different speeds based on radius, but spiral arms persist because they're <em>waves</em> — stars slow down and bunch up as they pass through, like cars in traffic.
    </div>

    <script>
    (function() {
        var canvas = document.getElementById('c');
        var ctx = canvas.getContext('2d');
        
        var W, H, cx, cy;
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            cx = W / 2;
            cy = H / 2;
        }
        resize();
        window.addEventListener('resize', resize);

        // Parameters
        var numStars = 8000;
        var numArms = 2;
        var armTightness = 0.4;
        var waveStrength = 0.5;
        var patternSpeed = 1.0;
        var rotationSpeed = 1.0;
        var showVelocity = false;

        // Stars array
        var stars = [];
        
        function initStars() {
            stars = [];
            var maxR = Math.min(W, H) * 0.45;
            
            for (var i = 0; i < numStars; i++) {
                // Exponential disk distribution
                var u = Math.random();
                var r = maxR * (1 - Math.pow(1 - u, 0.5)) * 0.9 + maxR * 0.05;
                
                // Base angle with some randomness
                var baseAngle = Math.random() * Math.PI * 2;
                
                // Orbital velocity (Keplerian-ish, modified for flat rotation curve)
                // v ∝ 1/sqrt(r) for Keplerian, but galaxies have flat rotation curves
                var orbitalPeriod = Math.pow(r / maxR, 0.5) * 200 + 50;
                
                stars.push({
                    r: r,
                    baseAngle: baseAngle,
                    orbitalPeriod: orbitalPeriod,
                    phase: Math.random() * Math.PI * 2,
                    // Slight eccentricity
                    eccentricity: Math.random() * 0.1,
                    eccPhase: Math.random() * Math.PI * 2,
                    // Star properties
                    size: Math.random() < 0.05 ? 1.5 + Math.random() : 0.8 + Math.random() * 0.5,
                    brightness: 0.5 + Math.random() * 0.5,
                    // Color based on position (bluer in arms, redder between)
                    colorBase: Math.random()
                });
            }
        }

        // Density wave potential - stars slow down here
        function getDensityWavePhase(r, angle, t, maxR) {
            // Logarithmic spiral pattern
            var spiralAngle = armTightness * Math.log(r / 50 + 1);
            
            // Pattern rotates slower than stars (key to density wave theory)
            var patternAngle = t * 0.0003 * patternSpeed;
            
            // How close is this angle to a spiral arm?
            var relAngle = angle - spiralAngle - patternAngle;
            var armPhase = relAngle * numArms;
            
            // Cosine gives smooth density variation
            var density = Math.cos(armPhase);
            
            return density;
        }

        // Get perturbed position due to density wave
        function getStarPosition(star, t, maxR) {
            // Base orbital motion
            var baseOrbitalAngle = star.baseAngle + (t / star.orbitalPeriod) * rotationSpeed;
            
            // Small epicyclic motion (eccentricity)
            var eccAngle = baseOrbitalAngle * 2 + star.eccPhase;
            var rPerturb = star.r * star.eccentricity * Math.cos(eccAngle);
            var r = star.r + rPerturb;
            
            // Density wave perturbation
            var densityPhase = getDensityWavePhase(r, baseOrbitalAngle, t, maxR);
            
            // Stars slow down in the wave (angular velocity perturbation)
            // This creates the bunching effect
            var anglePerturb = densityPhase * waveStrength * 0.3;
            
            // Slight radial perturbation too
            var radialPerturb = densityPhase * waveStrength * star.r * 0.05;
            
            var finalAngle = baseOrbitalAngle + anglePerturb;
            var finalR = r + radialPerturb;
            
            // Convert to cartesian
            var x = cx + finalR * Math.cos(finalAngle);
            var y = cy + finalR * Math.sin(finalAngle);
            
            // Calculate velocity for color coding
            var velocity = (star.r / maxR) * (1 + densityPhase * 0.3);
            
            return {
                x: x,
                y: y,
                density: densityPhase,
                velocity: velocity,
                r: finalR,
                angle: finalAngle
            };
        }

        var t = 0;

        function getStarColor(star, pos) {
            if (showVelocity) {
                // Velocity colormap: blue (slow) to red (fast)
                var v = pos.velocity;
                var r = Math.floor(50 + v * 200);
                var g = Math.floor(50 + (1 - Math.abs(v - 0.5) * 2) * 150);
                var b = Math.floor(250 - v * 200);
                return 'rgb(' + r + ',' + g + ',' + b + ')';
            } else {
                // Realistic colors: bluer in arms (young stars), redder between (old stars)
                var inArm = (pos.density + 1) / 2; // 0-1, higher in arms
                
                // Young blue stars more common in arms
                var temperature = star.colorBase * 0.5 + inArm * 0.5;
                
                var r, g, b;
                if (temperature > 0.7) {
                    // Blue-white (O/B stars)
                    r = 200 + Math.floor(temperature * 55);
                    g = 220 + Math.floor(temperature * 35);
                    b = 255;
                } else if (temperature > 0.4) {
                    // White-yellow (A/F/G stars)
                    r = 255;
                    g = 240 + Math.floor((temperature - 0.4) * 50);
                    b = 200 + Math.floor((temperature - 0.4) * 100);
                } else {
                    // Orange-red (K/M stars)
                    r = 255;
                    g = 180 + Math.floor(temperature * 150);
                    b = 150 + Math.floor(temperature * 100);
                }
                
                return 'rgb(' + r + ',' + g + ',' + b + ')';
            }
        }

        function drawGalaxy() {
            // Clear with slight fade for trails
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, W, H);
            
            var maxR = Math.min(W, H) * 0.45;
            
            // Draw central bulge glow
            var bulgeGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.15);
            bulgeGrad.addColorStop(0, 'rgba(255, 240, 200, 0.4)');
            bulgeGrad.addColorStop(0.5, 'rgba(255, 220, 150, 0.15)');
            bulgeGrad.addColorStop(1, 'rgba(255, 200, 100, 0)');
            ctx.fillStyle = bulgeGrad;
            ctx.fillRect(0, 0, W, H);
            
            // Draw stars
            for (var i = 0; i < stars.length; i++) {
                var star = stars[i];
                var pos = getStarPosition(star, t, maxR);
                
                // Skip if outside view
                if (pos.x < -10 || pos.x > W + 10 || pos.y < -10 || pos.y > H + 10) continue;
                
                var color = getStarColor(star, pos);
                var alpha = star.brightness * (0.6 + pos.density * 0.2);
                
                ctx.globalAlpha = Math.min(1, alpha);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.globalAlpha = 1;
            
            // Draw dust lanes (dark regions on inner edge of arms)
            ctx.globalCompositeOperation = 'multiply';
            for (var a = 0; a < numArms; a++) {
                var armAngle = (a / numArms) * Math.PI * 2;
                ctx.beginPath();
                for (var ri = 30; ri < maxR * 0.9; ri += 5) {
                    var spiralAngle = armTightness * Math.log(ri / 50 + 1);
                    var patternAngle = t * 0.0003 * patternSpeed;
                    var angle = armAngle + spiralAngle + patternAngle - 0.15; // Offset for inner edge
                    var x = cx + ri * Math.cos(angle);
                    var y = cy + ri * Math.sin(angle);
                    if (ri === 30) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.strokeStyle = 'rgba(50, 30, 20, 0.15)';
                ctx.lineWidth = 8;
                ctx.stroke();
            }
            ctx.globalCompositeOperation = 'source-over';
        }

        function render() {
            t += 16;
            drawGalaxy();
            requestAnimationFrame(render);
        }

        // Controls
        document.getElementById('sStars').oninput = function() {
            numStars = parseInt(this.value);
            document.getElementById('vStars').textContent = numStars;
            initStars();
        };
        document.getElementById('sArms').oninput = function() {
            numArms = parseInt(this.value);
            document.getElementById('vArms').textContent = numArms;
        };
        document.getElementById('sTight').oninput = function() {
            armTightness = parseFloat(this.value);
            document.getElementById('vTight').textContent = armTightness.toFixed(2);
        };
        document.getElementById('sWave').oninput = function() {
            waveStrength = parseFloat(this.value);
            document.getElementById('vWave').textContent = waveStrength.toFixed(2);
        };
        document.getElementById('sPat').oninput = function() {
            patternSpeed = parseFloat(this.value);
            document.getElementById('vPat').textContent = patternSpeed.toFixed(1);
        };
        document.getElementById('sRot').oninput = function() {
            rotationSpeed = parseFloat(this.value);
            document.getElementById('vRot').textContent = rotationSpeed.toFixed(1);
        };
        document.getElementById('viewToggle').onclick = function() {
            showVelocity = !showVelocity;
            this.textContent = showVelocity ? 'Toggle Normal View' : 'Toggle Velocity View';
        };

        initStars();
        render();
    })();
    </script>
</body>
</html>
